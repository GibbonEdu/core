{#<!--
Gibbon, Flexible & Open School System
Copyright (C) 2010, Ross Parker

This is a Gibbon template file, written in HTML and Twig syntax.
For info about editing, see: https://twig.symfony.com/doc/2.x/
-->#}

{{ form|raw }}

<div class="flex mt-4">

    <a href="./fullscreen.php?q=/modules/Reports/templates_preview.php&gibbonReportTemplateID={{ gibbonReportTemplateID }}&TB_iframe=true&width={{ template.orientation == 'P' ? 900 : 1200 }}&height=700" class="thickbox w-full mr-1 py-2 bg-gray-100 border text-gray-700 text-center text-base font-bold leading-normal hover:bg-blue-500 hover:border-blue-700 hover:text-white">{{ __('Preview HTML') }}</a>
    
    <a href="./export.php?q=/modules/Reports/templates_preview.php&gibbonReportTemplateID={{ gibbonReportTemplateID }}" class="w-full py-2 bg-gray-100 border text-gray-700 text-center text-base font-bold leading-normal hover:bg-blue-500 hover:border-blue-700 hover:text-white">{{ __('Preview PDF') }}</a>
</div>
        

<section class="flex items-stretch">
    <div class="flex-1 pr-3">
        {{ headers|raw }}

        {{ body|raw }}

        {{ footers|raw }}
    </div>

    <div id="sections" class="w-2/5 h-full pl-3">
        <h3>
            {{ __('Add Sections') }} <span class="text-xxs font-normal">{{ __('Drag & Drop') }}</span>
        </h3>
        <div class="prototype mt-3 "><!--p-2 bg-gray-100 rounded-sm border-->
        {% for category, sectionList in sections %}

            <div class="text-gray-600 text-xs mb-1 {{ not loop.first ? 'mt-3' }}">
                {{ category|title }}
            </div>

            <div class="flex flex-wrap">

                {% for section in sectionList %}
                <div class="prototypeItem flex flex-col items-center justify-around group relative w-24 p-2 mb-2 mr-2 bg-white border rounded hover:shadow-md cursor-move" data-section="{{ section.value }}">
                    <a class="thickbox absolute top-0 mt-1 right-0 mr-1 hidden group-hover:block opacity-50 hover:opacity-100" href="{{ absoluteURL }}/fullscreen.php?q=/modules/Reports/templates_prototypes_preview.php&gibbonReportTemplateID={{ gibbonReportTemplateID }}&gibbonReportPrototypeSectionID={{ section.value }}&TB_iframe=true&width=900&height=500">
                        <img class="w-4 h-4" title="{{ __('Preview') }}" src="{{ absoluteURL }}/themes/{{ gibbonThemeName }}/img/plus.png" >
                    </a>

                    <img class="w-8 h-8 opacity-50 mb-2" src="{{ absoluteURL }}/modules/Reports/img/icons/{{ section.icon ? section.icon : 'grip-lines.svg' }}">

                    <div class="text-center text-gray-600 text-xs leading-tight mt-px">{{ section.name }}</div>
                </div>
                {% endfor %}

            </div>
        {% endfor %}
        </div>
    </div>
</section>

<script>
    $('#sections .prototype .prototypeItem').draggable({
        helper: "clone",
        revert: "invalid",
    });

    var DroppableDataTable = {
        accept: '.prototypeItem',
        over: function(event, ui) {
            $(this).addClass('relative');
            $(this).append('<div id="droppable-overlay" class="absolute top-0 left-0 w-full h-full opacity-50 bg-gray-800 flex  items-stretch"><div class="flex-1 flex justify-center items-center m-6 border-4 border-dashed border-white text-white text-xl font-bold uppercase">{{ __('Drop Here') }}</div></div>');
        },
        out: function(event, ui) {
            $('#droppable-overlay').remove();
            $(this).removeClass('relative');
        },
        deactivate: function(event, ui) {
            $('#droppable-overlay').remove();
            $(this).removeClass('relative');
        },
        drop: function(event, ui) {
            // console.log(ui.draggable.data('section'));

            var table = $(this).hasClass('.blankslate') 
                ? $(this).parent().parent()
                : $(this).parents('.dataTable');

            var tableSelector = $(this).hasClass('.blankslate') 
                ? $(this).prop('id')
                : $(table).prop('id');

            // console.log(table);
            // console.log(tableSelector);

            $.ajax({
                url: '{{ absoluteURL }}/modules/Reports/templates_manage_editDropAjax.php',
                data: {
                    gibbonReportTemplateID: {{ gibbonReportTemplateID }},
                    gibbonReportPrototypeSectionID: ui.draggable.data('section'),
                    type: $(table).prop('id').replace('Table', '').toUpperCase(),
                },
                type: 'POST',
                complete: function (data) {
                    reloadDragDropState(table, tableSelector);
                },
                
            });
        },
    };

    var reloadDragDropState = function(table, tableSelector) {
        $(table).load('./fullscreen.php?q=/modules/Reports/templates_manage_edit.php&gibbonReportTemplateID={{ gibbonReportTemplateID }} #'+tableSelector, {}, function(responseText, textStatus, jqXHR) {
            console.log('reloaded');
            tb_init('a.thickbox');
            $('#'+tableSelector+' table[data-drag-url]').each(DraggableDataTable);
            $('#'+tableSelector+' tbody').droppable(DroppableDataTable);
        });
    };

    $('.dataTable tbody, .blankslate').droppable(DroppableDataTable);
</script>
