# see http://about.travis-ci.org/docs/user/languages/php/ for more hints
language: php

# The platforms you wants to test on
dist: trusty
os:
  - linux

# list any PHP version you want to test against
php:
  # using major version aliases

  # aliased to a recent 5.5.x version
  # - 5.5
  # aliased to a recent 5.6.x version
  # - 5.6
  # aliased to a recent 7.x version
  - 7.0

# optionally specify a list of environments, for example to test different RDBMS
env:
  global:
    - TEST_ENV='codeception'
    - ABSOLUTE_URL='http://127.0.0.1:8888'
    - DB_HOST='127.0.0.1'
    - DB_NAME='gibbon_test'
    - DB_USERNAME='root'
    - DB_PASSWORD=''
#    - LANG='en_GB' 
#    - LC_ALL='en_GB'
#    - LANGUAGE='en_GB'

# Dont need the extra depth
git:
  depth: 2

# enable php extensions
addons:
  apt:
    packages:
#      - language-pack-en
      - gettext

# optionally set up exclutions and allowed failures in the matrix
#matrix:
#  allow_failures:
#    - php: 7.0

# faster builds on new travis setup not using sudo
sudo: false

# Cache folder, you can delete cache from Travis CI web interface
cache:
  directories:
    - vendor
    - $HOME/.composer/cache

# Disable x-debug to speed up things
before_install:
  - phpenv config-rm xdebug.ini
  # - >
  #   touch config.php; printf '<?php $databaseServer=\"127.0.0.1\"; $databaseUsername=\"root\"; $databasePassword=\"\"; $databaseName=\"gibbon_test\"; $guid=\"testing\"; $caching=1; $testEnvironment=\"codeception\"; $testURL=\"http://127.0.0.1:8888\";' > config.php;
  - >
    touch composer.json; printf '{\"require-dev\": {}}' > composer.json;

# touch composer.json; printf '{\"require-dev\": {\"codeception/codeception\": \"^2.1\"}}' > composer.json;

# Install packages those will be required during build
# install:
  - travis_retry composer self-update
  - travis_retry composer global require "codeception/codeception:2.1.*@dev"
  - travis_retry composer install --prefer-dist --no-interaction

# execute any number of scripts before the test run, custom env's are available as variables
before_script:
#  - mysql -e "create database IF NOT EXISTS gibbon_test;" -uroot;
#  - mysql -uroot gibbon_test < gibbon.sql;
#  - mysql -uroot gibbon_test < gibbon_demo.sql;
#  - mysql -uroot gibbon_test < tests/config/data/install.sql;
#  - mysql -e "UPDATE gibbon_test.gibbonSetting SET value='${TRAVIS_BUILD_DIR}' WHERE scope='System' AND name='absolutePath';" -uroot;
#  - mysql -e "UPDATE gibbon_test.gibbonSetting SET value='http://127.0.0.1:8888' WHERE scope='System' AND name='absoluteURL';" -uroot;
  - php -S 127.0.0.1:8888 -t $TRAVIS_BUILD_DIR >/dev/null 2>&1 &
  - sleep 1
  - cd tests

# omitting "script:" will default to phpunit
# use the $DB env variable to determine the phpunit.xml to use
script:
  - ~/.composer/vendor/bin/codecept run install --env travis_ci
  - ~/.composer/vendor/bin/codecept run acceptance --env travis_ci
  - phpunit --verbose --configuration phpunit.xml

#after_script:

#after_success:

#after_failure:

# Tell Travis CI to monitor only 'Travis_CI' branch (for now)
branches:
  only: feature/Travis_CI

# configure notifications (email, IRC, campfire etc)
notifications:
  email: "sandra.kuipers@tis.edu.mo"
