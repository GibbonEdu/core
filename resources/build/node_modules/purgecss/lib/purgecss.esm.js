import{parse as t}from"postcss";import e from"postcss-selector-parser";import{access as s,readFile as r,constants as i}from"fs";import{promisify as n}from"util";import o from"glob";import a from"path";const c={css:[],content:[],defaultExtractor:t=>t.match(/[A-Za-z0-9_-]+/g)||[],extractors:[],fontFace:!1,keyframes:!1,rejected:!1,stdin:!1,stdout:!1,variables:!1,whitelist:[],whitelistPatterns:[],whitelistPatternsChildren:[]},u=["*","::-webkit-scrollbar","::selection",":root","::before","::after"];class h{constructor(t){this.nodes=[],this.isUsed=!1,this.value=t}}class l{constructor(){this.nodes=new Map,this.usedVariables=new Set}addVariable(t){const{prop:e}=t;if(!this.nodes.has(e)){const s=new h(t);this.nodes.set(e,s)}}addVariableUsage(t,e){const{prop:s}=t,r=this.nodes.get(s);for(const t of e){const e=t[1];if(this.nodes.has(e)){const t=this.nodes.get(e);null==r||r.nodes.push(t)}}}addVariableUsageInProperties(t){for(const e of t){const t=e[1];this.usedVariables.add(t)}}setAsUsed(t){const e=[this.nodes.get(t)];for(;0!==e.length;){const t=e.pop();t&&!t.isUsed&&(t.isUsed=!0,e.push(...t.nodes))}}removeUnused(){for(const t of this.usedVariables)this.setAsUsed(t);for(const[,t]of this.nodes)t.isUsed||t.value.remove()}}function d(t,e){e&&e.forEach(t.add,t)}class f{constructor(t){this.undetermined=new Set,this.attrNames=new Set,this.attrValues=new Set,this.classes=new Set,this.ids=new Set,this.tags=new Set,this.merge(t)}merge(t){return Array.isArray(t)?d(this.undetermined,t):t instanceof f?(d(this.undetermined,t.undetermined),d(this.attrNames,t.attrNames),d(this.attrValues,t.attrValues),d(this.classes,t.classes),d(this.ids,t.ids),d(this.tags,t.tags)):(d(this.undetermined,t.undetermined),t.attributes&&(d(this.attrNames,t.attributes.names),d(this.attrValues,t.attributes.values)),d(this.classes,t.classes),d(this.ids,t.ids),d(this.tags,t.tags)),this}hasAttrName(t){return this.attrNames.has(t)||this.undetermined.has(t)}someAttrValue(t){for(const e of this.attrValues)if(t(e))return!0;for(const e of this.undetermined)if(t(e))return!0;return!1}hasAttrPrefix(t){return this.someAttrValue(e=>e.startsWith(t))}hasAttrSuffix(t){return this.someAttrValue(e=>e.endsWith(t))}hasAttrSubstr(t){return this.someAttrValue(e=>e.includes(t))}hasAttrValue(t){return this.attrValues.has(t)||this.undetermined.has(t)}hasClass(t){return this.classes.has(t)||this.undetermined.has(t)}hasId(t){return this.ids.has(t)||this.undetermined.has(t)}hasTag(t){return this.tags.has(t)||this.undetermined.has(t)}}const m={access:n(s),readFile:n(r)};async function p(t="purgecss.config.js"){let e;try{const s=a.join(process.cwd(),t);e=await import(s)}catch(t){throw new Error(`Error loading the config file ${t.message}`)}return{...c,...e}}async function g(t,e){return new f(await e(t))}function v(t,e){switch(e){case"next":return t.text.includes("purgecss ignore");case"start":return t.text.includes("purgecss start ignore");case"end":return t.text.includes("purgecss end ignore")}}function y(...t){const e=new f([]);return t.forEach(e.merge,e),e}function w(t){return t.replace(/(^["'])|(["']$)/g,"")}function S(t,e){if(!e.hasAttrName(t.attribute))return!1;if(void 0===t.value)return!0;switch(t.operator){case"$=":return e.hasAttrSuffix(t.value);case"~=":case"*=":return e.hasAttrSubstr(t.value);case"=":return e.hasAttrValue(t.value);case"|=":case"^=":return e.hasAttrPrefix(t.value);default:return!0}}function b(t,e){return e.hasId(t.value)}function F(t,e){return e.hasTag(t.value)}class x{constructor(){this.ignore=!1,this.atRules={fontFace:[],keyframes:[]},this.usedAnimations=new Set,this.usedFontFaces=new Set,this.selectorsRemoved=new Set,this.variablesStructure=new l,this.options=c}collectDeclarationsData(t){const{prop:e,value:s}=t;if(this.options.variables){const r=function(t,e){const s=[];return t.replace(e,(function(){const e=arguments,r=Array.prototype.slice.call(e,0,-2);return r.input=e[e.length-1],r.index=e[e.length-2],s.push(r),t})),s}(s,/var\((.+?)[,)]/g);e.startsWith("--")?(this.variablesStructure.addVariable(t),r.length>0&&this.variablesStructure.addVariableUsage(t,r)):r.length>0&&this.variablesStructure.addVariableUsageInProperties(r)}if(!this.options.keyframes||"animation"!==e&&"animation-name"!==e)if(this.options.fontFace){if("font-family"===e)for(const t of s.split(",")){const e=w(t.trim());this.usedFontFaces.add(e)}}else;else for(const t of s.split(/[\s,]+/))this.usedAnimations.add(t)}getFileExtractor(t,e){const s=e.find(e=>e.extensions.find(e=>t.endsWith(e)));return void 0===s?this.options.defaultExtractor:s.extractor}async extractSelectorsFromFiles(t,e){const s=new f([]);for(const r of t){let t=[];try{await m.access(r,i.F_OK),t.push(r)}catch(e){t=o.sync(r,{nodir:!0})}for(const r of t){const t=await m.readFile(r,"utf-8"),i=this.getFileExtractor(r,e),n=await g(t,i);s.merge(n)}}return s}async extractSelectorsFromString(t,e){const s=new f([]);for(const{raw:r,extension:i}of t){const t=this.getFileExtractor(`.${i}`,e),n=await g(r,t);s.merge(n)}return s}evaluateAtRule(t){if(this.options.keyframes&&t.name.endsWith("keyframes"))this.atRules.keyframes.push(t);else if(this.options.fontFace&&"font-face"===t.name&&t.nodes)for(const e of t.nodes)"decl"===e.type&&"font-family"===e.prop&&this.atRules.fontFace.push({name:w(e.value),node:t})}async evaluateRule(t,s){if(this.ignore)return;const r=t.prev();if(r&&"comment"===r.type&&v(r,"next"))return void r.remove();if(t.parent&&"atrule"===t.parent.type&&"keyframes"===t.parent.name)return;if("rule"!==t.type)return;if(function(t){let e=!1;return t.walkComments(t=>{t&&"comment"===t.type&&t.text.includes("purgecss ignore current")&&(e=!0,t.remove())}),e}(t))return;let i=!0;if(t.selector=e(t=>{t.walk(t=>{"selector"===t.type&&(i=this.shouldKeepSelector(t,s),i||(this.options.rejected&&this.selectorsRemoved.add(t.toString()),t.remove()))})}).processSync(t.selector),i&&void 0!==t.nodes)for(const e of t.nodes)"decl"===e.type&&this.collectDeclarationsData(e);const n=t.parent;t.selector||t.remove(),function(t){return!!("rule"===t.type&&!t.selector||t.nodes&&!t.nodes.length||"atrule"===t.type&&(!t.nodes&&!t.params||!t.params&&t.nodes&&!t.nodes.length))}(n)&&n.remove()}async getPurgedCSS(e,s){const r=[],i=[];for(const t of e)"string"==typeof t?i.push(...o.sync(t,{nodir:!0})):i.push(t);for(const e of i){const i="string"==typeof e?this.options.stdin?e:await m.readFile(e,"utf-8"):e.raw,n=t(i);this.walkThroughCSS(n,s),this.options.fontFace&&this.removeUnusedFontFaces(),this.options.keyframes&&this.removeUnusedKeyframes(),this.options.variables&&this.removeUnusedCSSVariables();const o={css:n.toString(),file:"string"==typeof e?e:void 0};"string"==typeof e&&(o.file=e),this.options.rejected&&(o.rejected=Array.from(this.selectorsRemoved),this.selectorsRemoved.clear()),r.push(o)}return r}isSelectorWhitelisted(t){return u.includes(t)||this.options.whitelist&&this.options.whitelist.some(e=>e===t)||this.options.whitelistPatterns&&this.options.whitelistPatterns.some(e=>e.test(t))}isSelectorWhitelistedChildren(t){return this.options.whitelistPatternsChildren&&this.options.whitelistPatternsChildren.some(e=>e.test(t))}async purge(t){this.options="object"!=typeof t?await p(t):{...c,...t};const{content:e,css:s,extractors:r}=this.options,i=e.filter(t=>"string"==typeof t),n=e.filter(t=>"object"==typeof t),o=await this.extractSelectorsFromFiles(i,r),a=await this.extractSelectorsFromString(n,r);return this.getPurgedCSS(s,y(o,a))}removeUnusedCSSVariables(){this.variablesStructure.removeUnused()}removeUnusedFontFaces(){for(const{name:t,node:e}of this.atRules.fontFace)this.usedFontFaces.has(t)||e.remove()}removeUnusedKeyframes(){for(const t of this.atRules.keyframes)this.usedAnimations.has(t.params)||t.remove()}shouldKeepSelector(t,e){if(function(t){return t.parent&&"pseudo"===t.parent.type&&t.parent.value.startsWith(":")||!1}(t))return!0;let s=!1;for(const i of t.nodes){const t="attribute"===i.type&&i.attribute||i.value;if(t&&this.isSelectorWhitelistedChildren(t))return!0;if(t&&(u.includes(t)||this.isSelectorWhitelisted(t)))s=!0;else{switch(i.type){case"attribute":s=!!["value","checked","selected","open"].includes(i.attribute)||S(i,e);break;case"class":r=i,s=e.hasClass(r.value);break;case"id":s=b(i,e);break;case"tag":s=F(i,e)}if(!s)return!1}}var r;return s}walkThroughCSS(t,e){t.walk(t=>"rule"===t.type?this.evaluateRule(t,e):"atrule"===t.type?this.evaluateAtRule(t):void("comment"===t.type&&(v(t,"start")?(this.ignore=!0,t.remove()):v(t,"end")&&(this.ignore=!1,t.remove()))))}}export default x;export{x as PurgeCSS,c as defaultOptions,y as mergeExtractorSelectors,p as setOptions};
